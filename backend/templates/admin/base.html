{% extends "admin/base.html" %}

{% block extrahead %}
{{ block.super }}
<!-- Add Font Awesome for user avatar -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style type="text/css">
/* Ensure all action selectors have consistent font styling */
select[name="action"] {
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
}

/* User avatar styling in header */
.user-panel .user-avatar,
#header .user-tools .user-avatar,
.fas.fa-inverse.user-profile.fa-user-circle {
    color: #10a37f !important;
    font-size: 28px !important;
    margin-right: 8px !important;
    vertical-align: middle !important;
    display: inline-block !important;
}
</style>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // Global action selector improvement for all admin pages
    function improveActionSelectors() {
        const actionSelectors = document.querySelectorAll('select[name="action"]');
        actionSelectors.forEach(function(actionSelect) {
            const firstOption = actionSelect.querySelector('option[value=""]');
            if (firstOption) {
                const currentText = firstOption.textContent.trim();
                // Replace various default placeholders with consistent text
                if (currentText === '---------' || 
                    currentText === 'Select action' || 
                    currentText === 'Select Action' ||
                    currentText === '操作を選択' ||
                    currentText === 'アクションを選択') {
                    // Check user's language preference from Django's language setting
                    const htmlLang = document.documentElement.lang || 'en';
                    const isJapanese = htmlLang.startsWith('ja');
                    
                    // Set appropriate text based on language
                    firstOption.textContent = isJapanese ? 'アクションを選択' : 'Choose an action';
                }
            }
        });
    }
    
    // Run improvement immediately and after any dynamic content changes
    improveActionSelectors();
    
    // Also run when navigating between admin pages (for SPAs or dynamic content)
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                // Check if new action selectors were added
                const hasNewSelectors = Array.from(mutation.addedNodes).some(function(node) {
                    return node.nodeType === 1 && (
                        node.matches && node.matches('select[name="action"]') ||
                        node.querySelector && node.querySelector('select[name="action"]')
                    );
                });
                if (hasNewSelectors) {
                    setTimeout(improveActionSelectors, 100);
                }
            }
        });
    });
    
    // Observe the document for dynamic changes
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });

    // Silent timezone detection for Django admin (no popup, no auto-refresh)
    function detectAndSetTimezone() {
        // Check if timezone is already detected in this session
        if (sessionStorage.getItem('timezone_detected')) {
            return;
        }
        
        try {
            // Use Intl API to detect browser timezone
            const detectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            if (detectedTimezone) {
                console.log('Detected browser timezone:', detectedTimezone);
                
                // Send timezone to server
                fetch('/api/timezone/detect/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        timezone: detectedTimezone
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Timezone successfully set on server:', data.timezone);
                        
                        // Mark timezone as detected in session storage
                        sessionStorage.setItem('timezone_detected', 'true');
                        sessionStorage.setItem('user_timezone', data.timezone);
                        
                        // NO POPUP - removed showTimezoneNotification() call
                        // NO AUTO-REFRESH - removed the page reload logic
                    } else {
                        console.warn('Failed to set timezone:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error setting timezone:', error);
                });
            } else {
                console.warn('Could not detect browser timezone');
            }
        } catch (error) {
            console.error('Timezone detection failed:', error);
        }
    }
    
    // Run timezone detection after a short delay to ensure page is fully loaded
    setTimeout(detectAndSetTimezone, 500);

    // Style existing avatar instead of adding a new one
    function styleExistingAvatar() {
        // Find existing avatar element
        const existingAvatar = document.querySelector('.fas.fa-inverse.user-profile.fa-user-circle');
        
        if (existingAvatar) {
            // Apply our custom styling to the existing avatar
            existingAvatar.style.color = '#10a37f';
            existingAvatar.style.fontSize = '28px';
            existingAvatar.style.marginLeft = '12px';
            existingAvatar.style.marginRight = '12px';
            existingAvatar.style.verticalAlign = 'middle';
            existingAvatar.style.display = 'inline-block';
            
            console.log('Styled existing user avatar');
        } else {
            console.log('No existing avatar found to style');
        }
    }
    
    // Style existing avatar after page load
    setTimeout(styleExistingAvatar, 100);
});
</script>
{% endblock %}